
<!DOCTYPE html>

<html> 

<head> 

    <meta name="viewport" content="width=device-width, initial-scale=0.86"> 
    <title>HLA-DPB1 Compatibility Wizard</title> 
    <script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />
    <script src="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>

    <style>

        table.grid {
            border-collapse: collapse;
        }
        table.grid th {
            border: 1px solid black;
            padding: 5px;
            vertical-align: bottom;
            text-align: center;
        }
        table.grid td {
            border: 1px solid black;
            padding: 5px;
            vertical-align: top;
        }

    </style>

</head>

<body>

    <div id="recipientHlaTypePage" data-role="page">

        <div data-role="header">
            <h1>HLA-DPB1 Compatibility Wizard</h1>
            <div style="height: 20px;"><div class="multiId-working" style="display: inline-block; width: 100%; height: 20px; text-align: center; background-color: red; color: white; font-weight: bold;">working...</div></div>
        </div>


        <div class="ui-content">
            <fieldset class="ui-grid-b">
                <div class="ui-block-a"><a data-role="button" class="button-prev ui-disabled" data-icon="arrow-l">Prev</a></div>
                <div class="ui-block-b"><a class="multiId-resetButton" data-role="button"">Reset</a></div>
                <div class="ui-block-c"><a href="#singleAntigenBeadPage" data-role="button" class="button-next" data-icon="arrow-r" data-iconpos="right">Next</a></div>
            </fieldset>        
            <div>
                <h3>1 of 5. Select the RECIPIENT's HLA-DPB1 type.</h3>
                <div class="options">
                    <fieldset class="ui-grid-a">
                        <div class="ui-block-a" style="padding-left: 2px; padding-right: 5px;">
                            <h3>Allele #1: <span id="recipientHlaType1" style="border: 1px solid darkgrey; background: lightgrey; padding: 3px;">not selected</span></h3>
                        </div>
                        <div class="ui-block-b" style="padding-left: 5px; padding-right: 2px;">
                            <h3>Allele #2: <span id="recipientHlaType2" style="border: 1px solid darkgrey; background: lightgrey; padding: 3px;">not selected</span></h3>
                        </div>
                    </fieldset>
                </div>
            </div>
        </div>
           
        <div data-role="footer" style="text-align: center;">
            <div style="display: inline-block; text-align: right; vertical-align: middle">
                <img src="https://hlatools.org/htLogoTransparent.png">&nbsp;&nbsp;
            </div>
            <div style="display: inline-block; text-align: left; vertical-align: middle; margin-top: 5px; margin-bottom: 5px; border-left: 1px solid black; padding-left: 5px;">
                    <span style="font-size: small;">FOR RESEARCH USE ONLY
                    <br/>session ID: <span class="multiId-reportId"></span>
                    <br/>IMGT allele database version: <span class="multiId-imgtHlaVersion"></span>
                    <br/>single antigen bead (SAB) reagent lot number: <span class="multiId-oneLambdaLotNo"></span>
                    <br/><a href="https://github.com/ghsmith/hladpb1/blob/master/hladpb1-webServices/src/main/webapp/ajaxMobileCompatibilityWizard.html">source code</a>
                    <br/>Copyright &copy; 2018, Geoffrey H. Smith, MD</span>
            </div>
        </div>

    </div>

    <div id="singleAntigenBeadPage" data-role="page">

        <div data-role="header">
            <h1>HLA-DPB1 Compatibility Wizard</h1>
            <div style="height: 20px;"><div class="multiId-working" style="display: inline-block; width: 100%; height: 20px; text-align: center; background-color: red; color: white; font-weight: bold;">working...</div></div>
        </div>

        <div class="ui-content">
            <fieldset class="ui-grid-b">
                <div class="ui-block-a"><a href="#recipientHlaTypePage" data-role="button" class="button-prev" data-icon="arrow-l">Prev</a></div>
                <div class="ui-block-b"><a class="multiId-resetButton" data-role="button"">Reset</a></div>
                <div class="ui-block-c"><a href="#recipientEpitopePage" data-role="button" class="button-next" data-icon="arrow-r" data-iconpos="right">Next</a></div>
            </fieldset>        
            <div>
                <h3>2 of 5. Select the recipient's HLA-DPB1 antibodies (positive single antigen beads).</h3>
                <p>Reactivity for an HLA-DPB1 epitope is predicted when all of the beads bearing that epitope are positive, unless the epitope is present on any of the recipient's HLA-DPB1 alleles.</p>
                <div class="options"></div>
            </div>
        </div>

        <div data-role="footer" style="text-align: center;">
            <div style="display: inline-block; text-align: right; vertical-align: middle">
                <img src="https://hlatools.org/htLogoTransparent.png">&nbsp;&nbsp;
            </div>
            <div style="display: inline-block; text-align: left; vertical-align: middle; margin-top: 5px; margin-bottom: 5px; border-left: 1px solid black; padding-left: 5px;">
                    <span style="font-size: small;">FOR RESEARCH USE ONLY
                    <br/>session ID: <span class="multiId-reportId"></span>
                    <br/>IMGT allele database version: <span class="multiId-imgtHlaVersion"></span>
                    <br/>single antigen bead (SAB) reagent lot number: <span class="multiId-oneLambdaLotNo"></span>
                    <br/><a href="https://github.com/ghsmith/hladpb1/blob/master/hladpb1-webServices/src/main/webapp/ajaxMobileCompatibilityWizard.html">source code</a>
                    <br/>Copyright &copy; 2018, Geoffrey H. Smith, MD</span>
            </div>
        </div>

    </div>

    <div id="recipientEpitopePage" data-role="page">

        <div data-role="header">
            <h1>HLA-DPB1 Compatibility Wizard</h1>
            <div style="height: 20px;"><div class="multiId-working" style="display: inline-block; width: 100%; height: 20px; text-align: center; background-color: red; color: white; font-weight: bold;">working...</div></div>
        </div>

        <div class="ui-content">
            <fieldset class="ui-grid-b">
                <div class="ui-block-a"><a href="#singleAntigenBeadPage" data-role="button" class="button-prev" data-icon="arrow-l">Prev</a></div>
                <div class="ui-block-b"><a class="multiId-resetButton" data-role="button"">Reset</a></div>
                <div class="ui-block-c"><a href="#donorHlaTypePage" data-role="button" class="button-next" data-icon="arrow-r" data-iconpos="right">Next</a></div>
            </fieldset>        
            <div>
                <h3>3 of 5. Select any HLA-DPB1 epitopes for which the recipient has known HLA-DPB1 antibodies.</h3>
                <p>Any HLA-DPB1 epitopes selected here are added to the set of reactive epitopes predicted from bead positivity in the previous step, unless the epitope is present on any of the recipient's HLA-DPB1 alleles.</p>
                <div class="options"></div>
            </div>
        </div>
           
        <div data-role="footer" style="text-align: center;">
            <div style="display: inline-block; text-align: right; vertical-align: middle">
                <img src="https://hlatools.org/htLogoTransparent.png">&nbsp;&nbsp;
            </div>
            <div style="display: inline-block; text-align: left; vertical-align: middle; margin-top: 5px; margin-bottom: 5px; border-left: 1px solid black; padding-left: 5px;">
                    <span style="font-size: small;">FOR RESEARCH USE ONLY
                    <br/>session ID: <span class="multiId-reportId"></span>
                    <br/>IMGT allele database version: <span class="multiId-imgtHlaVersion"></span>
                    <br/>single antigen bead (SAB) reagent lot number: <span class="multiId-oneLambdaLotNo"></span>
                    <br/><a href="https://github.com/ghsmith/hladpb1/blob/master/hladpb1-webServices/src/main/webapp/ajaxMobileCompatibilityWizard.html">source code</a>
                    <br/>Copyright &copy; 2018, Geoffrey H. Smith, MD</span>
            </div>
        </div>

    </div>

    <div id="donorHlaTypePage" data-role="page">

        <div data-role="header">
            <h1>HLA-DPB1 Compatibility Wizard</h1>
            <div style="height: 20px;"><div class="multiId-working" style="display: inline-block; width: 100%; height: 20px; text-align: center; background-color: red; color: white; font-weight: bold;">working...</div></div>
        </div>

        <div class="ui-content">
            <fieldset class="ui-grid-b">
                <div class="ui-block-a"><a href="#recipientEpitopePage" data-role="button" class="button-prev" data-icon="arrow-l">Prev</a></div>
                <div class="ui-block-b"><a class="multiId-resetButton" data-role="button"">Reset</a></div>
                <div class="ui-block-c"><a href="#compatibilityReportPage" data-role="button" class="button-next" data-icon="arrow-r" data-iconpos="right">Next</a></div>
            </fieldset>        
            <div>
                <h3>4 of 5. Select the DONOR's HLA-DPB1 type.</h3>
                <div class="options">
                    <fieldset class="ui-grid-a">
                        <div class="ui-block-a" style="padding-left: 2px; padding-right: 5px;">
                            <h3>Allele #1: <span id="donorHlaType1" style="border: 1px solid darkgrey; background: lightgrey; padding: 3px;">not selected</span></h3>
                        </div>
                        <div class="ui-block-b" style="padding-left: 5px; padding-right: 2px;">
                            <h3>Allele #2: <span id="donorHlaType2" style="border: 1px solid darkgrey; background: lightgrey; padding: 3px;">not selected</span></h3>
                        </div>
                    </fieldset>
                </div>
            </div>
        </div>
           
        <div data-role="footer" style="text-align: center;">
            <div style="display: inline-block; text-align: right; vertical-align: middle">
                <img src="https://hlatools.org/htLogoTransparent.png">&nbsp;&nbsp;
            </div>
            <div style="display: inline-block; text-align: left; vertical-align: middle; margin-top: 5px; margin-bottom: 5px; border-left: 1px solid black; padding-left: 5px;">
                    <span style="font-size: small;">FOR RESEARCH USE ONLY
                    <br/>session ID: <span class="multiId-reportId"></span>
                    <br/>IMGT allele database version: <span class="multiId-imgtHlaVersion"></span>
                    <br/>single antigen bead (SAB) reagent lot number: <span class="multiId-oneLambdaLotNo"></span>
                    <br/><a href="https://github.com/ghsmith/hladpb1/blob/master/hladpb1-webServices/src/main/webapp/ajaxMobileCompatibilityWizard.html">source code</a>
                    <br/>Copyright &copy; 2018, Geoffrey H. Smith, MD</span>
            </div>
        </div>

    </div>

    <div id="compatibilityReportPage" data-role="page">

        <div data-role="header">
            <h1>HLA-DPB1 Compatibility Wizard</h1>
            <div style="height: 20px;"><div class="multiId-working" style="display: inline-block; width: 100%; height: 20px; text-align: center; background-color: red; color: white; font-weight: bold;">working...</div></div>
        </div>

        <div class="ui-content">
            <fieldset class="ui-grid-b">
                <div class="ui-block-a"><a href="#donorHlaTypePage" data-role="button" class="button-prev" data-icon="arrow-l">Prev</a></div>
                <div class="ui-block-b"><a class="multiId-resetButton" data-role="button"">Reset</a></div>
                <div class="ui-block-c"><a href="" data-role="button" class="button-next ui-disabled" data-icon="arrow-r" data-iconpos="right">Next</a></div>
            </fieldset>        
            <div>
                <h3>5 of 5. Here is the HLA-DPB1 compatibility report for this recipient and donor.</h3>
                <p>Compatibility predictions are based on the union of the user-specified epitopes and the predicted epitopes, and automatically exclude epitopes that are present on any of the recipient's own alleles.</p>
                <p>
                    <table>
                        <tr><td>Recipient Allele #1</td><td>:</td><td><span id="repRecipientHlaType1" style="line-height: 2; border: 1px solid black; background: white; padding: 3px;"></span></td><td><span id="repRecipientHlaType1Epitopes" style="font-style: italic;"></span></td></tr>
                        <tr><td>Recipient Allele #2</td><td>:</td><td><span id="repRecipientHlaType2" style="line-height: 2; border: 1px solid black; background: white; padding: 3px;"></span></td><td><span id="repRecipientHlaType2Epitopes" style="font-style: italic;"></span></td></tr>
                    </table>
                </p>
                <p>
                    <table>
                        <tr><td>Recipient Antibodies (positive SABs)</td><td>:</td><td><span id="repRecipientAntibodies" style="line-height: 2; border: 1px solid black; background: white; padding: 3px;"></span></td></tr>
                    </table>
                </p>
                <p>
                    <table>
                        <tr><td>Reactive Recipient Epitopes (user-specified)</td><td>:</td><td><span id="repRecipientEpitopesUser" style="line-height: 2; border: 1px solid black; background: white; padding: 3px;"></span></td></tr>
                        <tr><td>Reactive Recipient Epitopes (predicted from positive SABs)</td><td>:</td><td><span id="repRecipientEpitopesPrediction" style="line-height: 2; border: 1px solid black; background: white; padding: 3px;"></span></td></tr>
                    </table>
                </p>
                <p>
                    <table>
                        <tr><td>Donor Allele #1</td><td>:</td><td><span id="repDonorHlaType1" style="line-height: 2; border: 1px solid black; background: white; padding: 3px;"></span></td><td><span id="repDonorHlaType1CompatibilityPrediction" style="font-weight: bold; font-style: italic;"></span></td></tr>
                        <tr><td>Donor Allele #2</td><td>:</td><td><span id="repDonorHlaType2" style="line-height: 2; border: 1px solid black; background: white; padding: 3px;"></span></td><td><span id="repDonorHlaType2CompatibilityPrediction" style="font-weight: bold; font-style: italic;"></span></td></tr>
                    </table>
                </p>
                <p>All HLA-DPB1 alleles by compatibility:</p>
                <p>
                    <table class="grid">
                        <tr>
                            <th style="font-weight: bold; color: white; background-color: red;">Incompatible<br/><a href="#popupIncompatible" data-rel="popup" data-transition="pop" class="my-tooltip-btn ui-btn ui-alt-icon ui-nodisc-icon ui-btn-inline ui-icon-info ui-btn-icon-notext" title="Learn more">Learn more</a></th>
                            <th style="font-weight: bold; color: white; background-color: orange;">Likely<br/>Incompatible<br/><a href="#popupLikelyIncompatible" data-rel="popup" data-transition="pop" class="my-tooltip-btn ui-btn ui-alt-icon ui-nodisc-icon ui-btn-inline ui-icon-info ui-btn-icon-notext" title="Learn more">Learn more</a></th>
                            <th style="font-weight: bold; color: white; background-color: green;">Likely<br/>Compatible<br/><a href="#popupLikelyCompatible" data-rel="popup" data-transition="pop" class="my-tooltip-btn ui-btn ui-alt-icon ui-nodisc-icon ui-btn-inline ui-icon-info ui-btn-icon-notext" title="Learn more">Learn more</a></th>
                            <th style="font-weight: bold; color: white; background-color: blue;">Autoantibody<br/><a href="#popupPossibleAutoantibody" data-rel="popup" data-transition="pop" class="my-tooltip-btn ui-btn ui-alt-icon ui-nodisc-icon ui-btn-inline ui-icon-info ui-btn-icon-notext" title="Learn more">Learn more</a></th></tr>
                        <tr><td id="incompatible" style="color: red;"></td><td id="likelyIncompatible" style="color: orange;"></td><td id="likelyCompatible" style="color: green;"></td><td id="possibleAutoantibody" style="color: blue;"></td></tr>
                    </table>
                </p>
            </div>
            <div data-role="popup" id="popupIncompatible" class="ui-content" data-theme="a" style="max-width:350px;">
                <p>The single antigen bead corresponding to this allele is positive.</p>
            </div>
            <div data-role="popup" id="popupLikelyIncompatible" class="ui-content" data-theme="a" style="max-width:350px;">
                <p>This allele has an epitope which is likely to be reactive with recipient antibodies.</p>
            </div>
            <div data-role="popup" id="popupLikelyCompatible" class="ui-content" data-theme="a" style="max-width:350px;">
                <p>This allele is not listed in any of the other categories and is likely to be compatible with the recipient.</p>
            </div>
            <div data-role="popup" id="popupPossibleAutoantibody" class="ui-content" data-theme="a" style="max-width:350px;">
                <p>The single antigen bead corresponding to this allele is positive, but it is also a recipient allele.</p>
            </div>
        </div>
            
        <div data-role="footer" style="text-align: center;">
            <div style="display: inline-block; text-align: right; vertical-align: middle">
                <img src="https://hlatools.org/htLogoTransparent.png">&nbsp;&nbsp;
            </div>
            <div style="display: inline-block; text-align: left; vertical-align: middle; margin-top: 5px; margin-bottom: 5px; border-left: 1px solid black; padding-left: 5px;">
                    <span style="font-size: small;">FOR RESEARCH USE ONLY
                    <br/>session ID: <span class="multiId-reportId"></span>
                    <br/>IMGT allele database version: <span class="multiId-imgtHlaVersion"></span>
                    <br/>single antigen bead (SAB) reagent lot number: <span class="multiId-oneLambdaLotNo"></span>
                    <br/><a href="https://github.com/ghsmith/hladpb1/blob/master/hladpb1-webServices/src/main/webapp/ajaxMobileCompatibilityWizard.html">source code</a>
                    <br/>Copyright &copy; 2018, Geoffrey H. Smith, MD</span>
            </div>
        </div>
            
    </div>

</body>

</html>

<script type="text/javascript">

var pageInitedMap = new Object();
var alleles = []; // the array of alleles
var alleleMap = new Object(); // a map of alleles, indexed by allele name
var hypervariableRegions = []; // the array of hypervariableRegions
var hvrMap = new Object(); // a map of hypervariable regions, indexed by hypervariable region name + variant ID
var hvrvMap = new Object(); // a map of hypervariable region variants, indexd by hypervariable region anme + variant ID
var compatibilityMap = {
    "I":  {text: "Incompatibile"       , color: "red"    },
    "LI": {text: "Likely Incompatibile", color: "orange" },
    "LC": {text: "Likely Compatible"   , color: "green"  },
    "AA": {text: "Autoantibody"        , color: "blue"   }
}

function getSessionId() {
    $(".multiId-working").show();
    return $.ajax({
        url: "/hladpb1/resources/session",
        dataType: "text"
    }).then(function(response) {
        sessionId = response;
        $(".multiId-reportId").html(sessionId);
    });
}

function resetSession() {
    $(".multiId-working").show();
    return $.ajax({
        url: "/hladpb1/resources/session/reset",
        dataType: "json",
        type: "PUT",
        contentType: "application/json"
    });
}

// Get reagent lot number.
function getReagentLotNumber() {
    $(".multiId-working").show();
    return $.ajax({
        url: "/hladpb1/resources/hypervariableRegions/reagentLotNumber",
        dataType: "json"
    }).then(function(response) {
        reagentLotNumber = response;
        $(".multiId-oneLambdaLotNo").html(reagentLotNumber);
    });
}

// Get all hypervariable regions.
function getHypervariableRegions() {
    $(".multiId-working").show();
    return $.ajax({
        url: "/hladpb1/resources/hypervariableRegions",
        dataType: "json"
    }).then(function(response) {
        hypervariableRegions = response;
        hypervariableRegions.forEach(function(hypervariableRegion) {
            hvrMap[hypervariableRegion.hypervariableRegionName] = hypervariableRegion;
            $.each(hypervariableRegion.variantMap, function(index, hvrv) {
                hvrvMap[hypervariableRegion.hypervariableRegionName + hvrv.variantId] = hvrv;
            });
        });
    });
}

// Put a hypervariable region (updates known reactive epitope attribute).
function putHypervariableRegion(hypervariableRegion) {
    $(".multiId-working").show();
    return $.ajax({
        url: "/hladpb1/resources/hypervariableRegions/" + hypervariableRegion.hypervariableRegionName,
        dataType: "json",
        type: "PUT",
        contentType: "application/json",
        data: JSON.stringify(hypervariableRegion)
    });
}

// Get all alleles.
function getAlleles() {
    $(".multiId-working").show();
    return $.ajax({
        url: "/hladpb1/resources/alleles?noCodons=true&synonymous=false", // always filter out synonymous alleles
        dataType: "json"
    }).then(function(response) {
        alleles = response;
        alleles.forEach(function(allele) {
            alleleMap[allele.alleleName] = allele;
        });
        $(".multiId-imgtHlaVersion").html(alleles[0].version);
    });
}

// Put an allele (updates donor type, recipient type, and recipient antibodies).
function putAllele(allele) {
    $(".multiId-working").show();
    return $.ajax({
        url: "/hladpb1/resources/alleles/" + allele.alleleName + "?enumeratedAlleleMode=true",
        dataType: "json",
        type: "PUT",
        contentType: "application/json",
        data: JSON.stringify(allele)
    });
}

function initData(refresh) {
    var dfr = $.Deferred();
    setTimeout(function() {
        if(refresh || alleles.length == 0) {
            getSessionId().then(getReagentLotNumber).then(getHypervariableRegions).then(getAlleles).done(function() { dfr.resolve(); });
        }
        else {
            $(".multiId-working").show();
            setTimeout(function() { dfr.resolve(); }, 500); // this makes sure the static parts of the page appear before any rendering delays
        }
    }, 1);
    return dfr.promise();
}

$("#recipientHlaTypePage").bind("pageinit", function () {

    pageInitedMap["#recipientHlaTypePage"] = true;

    initData(false).done(function() {

        $("#recipientHlaTypePage div.options div.ui-block-a fieldset").remove();
        $("#recipientHlaType1").html("not selected");
        $("#recipientHlaTypePage div.options div.ui-block-a").append("<fieldset data-role='controlgroup' data-filter='true' data-filter-reveal='true' data-filter-placeholder='type allele name...'></fieldset>");
        $.each(alleles, function(index, allele) {
            $("#recipientHlaTypePage div.options div.ui-block-a fieldset").append("<label>" + allele.alleleName + "<input type='radio' name='recipientHlaType1' " + (allele.recipientAllele1 ? "checked='true'" : "") + "></label>");
            if(allele.recipientAllele1) {
                $("#recipientHlaType1").html(allele.alleleName);
            }
        });
        $("#recipientHlaTypePage div.options div.ui-block-a").trigger("create");
        $("#recipientHlaTypePage div.options div.ui-block-a input").change(function(event) {
            var allele = alleles[$(this).parent().index()];
            allele.recipientAllele1 = $(this).is(":checked");
            if(allele.recipientAllele1) {
                $("#recipientHlaType1").html(allele.alleleName);
                putAllele(allele).done(function() { $(".multiId-working").fadeOut(); });
            }
            $("#recipientHlaTypePage div.options div.ui-block-a input[data-type=search]").blur();
            $("#recipientHlaTypePage div.options div.ui-block-b input[data-type=search]").blur();
        });

        $("#recipientHlaTypePage div.options div.ui-block-b fieldset").remove();
        $("#recipientHlaType2").html("not selected");
        $("#recipientHlaTypePage div.options div.ui-block-b").append("<fieldset data-role='controlgroup' data-filter='true' data-filter-reveal='true' data-filter-placeholder='type allele name...'></fieldset>");
        $.each(alleles, function(index, allele) {
            $("#recipientHlaTypePage div.options div.ui-block-b fieldset").append("<label>" + allele.alleleName + "<input type='radio' name='recipientHlaType2' " + (allele.recipientAllele2 ? "checked='true'" : "") + "></label>");
            if(allele.recipientAllele2) {
                $("#recipientHlaType2").html(allele.alleleName);
            }
        });
        $("#recipientHlaTypePage div.options div.ui-block-b").trigger("create");
        $("#recipientHlaTypePage div.options div.ui-block-b input").change(function(event) {
            var allele = alleles[$(this).parent().index()];
            allele.recipientAllele2 = $(this).is(":checked");
            if(allele.recipientAllele2) {
                $("#recipientHlaType2").html(allele.alleleName);
                putAllele(allele).done(function() { $(".multiId-working").fadeOut(); });
            }
            $("#recipientHlaTypePage div.options div.ui-block-a input[data-type=search]").blur();
            $("#recipientHlaTypePage div.options div.ui-block-b input[data-type=search]").blur();
        });

        $(".multiId-working").fadeOut();
        
    });
    
});

$("#recipientHlaTypePage").bind("pageshow", function () {
    
    if(!pageInitedMap["#recipientHlaTypePage"]) {
        $("#recipientHlaTypePage").trigger("pageinit");
    }
    
});

$("#singleAntigenBeadPage").bind("pageinit", function () {

    pageInitedMap["#singleAntigenBeadPage"] = true;

    initData(false).done(function() {

        $("#singleAntigenBeadPage div.options fieldset").remove();
        $("#singleAntigenBeadPage div.options").append("<fieldset data-role='controlgroup'></fieldset>");
        $.each(alleles.filter(function(allele) { return allele.singleAntigenBead; }), function(index, sabAllele) {
            $("#singleAntigenBeadPage div.options fieldset").append("<label>" + sabAllele.alleleName + "<input type='checkbox' name='singleAntigenBead' data-name='" + sabAllele.alleleName + "' " + (sabAllele.recipientAntibodyForCompat ? "checked='true'" : "") + "></label>");
        });
        $("#singleAntigenBeadPage div.options").trigger("create");
        $("#singleAntigenBeadPage div.options input").change(function(event) {
            var sabAllele = alleleMap[$(this).data("name")];
            sabAllele.recipientAntibodyForCompat = $(this).is(":checked");
            putAllele(sabAllele).done(function() { $(".multiId-working").fadeOut(); });
        });
        
        $(".multiId-working").fadeOut();        
        
    });

});

$("#singleAntigenBeadPage").bind("pageshow", function () {
    
    if(!pageInitedMap["#singleAntigenBeadPage"]) {
        $("#singleAntigenBeadPage").trigger("pageinit");
    }
    
});


$("#recipientEpitopePage").bind("pageinit", function () {

    pageInitedMap["#recipientEpitopePage"] = true;

    initData(false).done(function() {

        $("#recipientEpitopePage div.options fieldset").remove();
        $("#recipientEpitopePage div.options").append("<fieldset data-role='controlgroup'></fieldset>");
        $.each(hypervariableRegions, function(index, hypervariableRegion) { $.each(hypervariableRegion.variantMap, function(index, hvrv) {
            $("#recipientEpitopePage div.options fieldset").append("<label>epitope name: " + hypervariableRegion.hypervariableRegionName + hvrv.variantId + "<br>codon position(s): " + hypervariableRegion.codonNumberList.join(", ") + "<br>protein sequence(s): " + hvrv.proteinSequenceList.join(", ") + "<input type='checkbox' name='hypervariableRegion' data-container='" + hypervariableRegion.hypervariableRegionName + "' data-name='" + hypervariableRegion.hypervariableRegionName + hvrv.variantId + "' " + (hvrv.knownReactiveEpitopeForCompat ? "checked='true'" : "") + "></label>");
        }); });
        $("#recipientEpitopePage div.options").trigger("create");
        $("#recipientEpitopePage div.options input").change(function(event) {
            var hypervariableRegion = hvrMap[$(this).data("container")];
            var hvrv = hvrvMap[$(this).data("name")];
            hvrv.knownReactiveEpitopeForCompat = $(this).is(":checked");
            putHypervariableRegion(hypervariableRegion).done(function() { $(".multiId-working").fadeOut(); });
        });

        $(".multiId-working").fadeOut();
        
    });
    
});

$("#recipientEpitopePage").bind("pageshow", function () {
    
    if(!pageInitedMap["#recipientEpitopePage"]) {
        $("#recipientEpitopePage").trigger("pageinit");
    }
    
});

$("#donorHlaTypePage").bind("pageinit", function () {

    pageInitedMap["#donorHlaTypePage"] = true;

    initData(false).done(function() {

        $("#donorHlaTypePage div.options div.ui-block-a fieldset").remove();
        $("#donorHlaType1").html("not selected");
        $("#donorHlaTypePage div.options div.ui-block-a").append("<fieldset data-role='controlgroup' data-filter='true' data-filter-reveal='true' data-filter-placeholder='type allele name...'></fieldset>");
        $.each(alleles, function(index, allele) {
            $("#donorHlaTypePage div.options div.ui-block-a fieldset").append("<label>" + allele.alleleName + "<input type='radio' name='donorHlaType1' " + (allele.donorAllele1 ? "checked='true'" : "") + "></label>");
            if(allele.donorAllele1) {
                $("#donorHlaType1").html(allele.alleleName);
            }
        });
        $("#donorHlaTypePage div.options div.ui-block-a").trigger("create");
        $("#donorHlaTypePage div.options div.ui-block-a input").change(function(event) {
            var allele = alleles[$(this).parent().index()];
            allele.donorAllele1 = $(this).is(":checked");
            if(allele.donorAllele1) {
                $("#donorHlaType1").html(allele.alleleName);
                putAllele(allele).done(function() { $(".multiId-working").fadeOut(); });
            }
            $("#donorHlaTypePage div.options div.ui-block-a input[data-type=search]").blur();
            $("#donorHlaTypePage div.options div.ui-block-b input[data-type=search]").blur();
        });

        $("#donorHlaTypePage div.options div.ui-block-b fieldset").remove();
        $("#donorHlaType2").html("not selected");
        $("#donorHlaTypePage div.options div.ui-block-b").append("<fieldset data-role='controlgroup' data-filter='true' data-filter-reveal='true' data-filter-placeholder='type allele name...'></fieldset>");
        $.each(alleles, function(index, allele) {
            $("#donorHlaTypePage div.options div.ui-block-b fieldset").append("<label>" + allele.alleleName + "<input type='radio' name='donorHlaType2' " + (allele.donorAllele2 ? "checked='true'" : "") + "></label>");
            if(allele.donorAllele2) {
                $("#donorHlaType2").html(allele.alleleName);
            }
        });
        $("#donorHlaTypePage div.options div.ui-block-b").trigger("create");
        $("#donorHlaTypePage div.options div.ui-block-b input").change(function(event) {
            var allele = alleles[$(this).parent().index()];
            allele.donorAllele2 = $(this).is(":checked");
            if(allele.donorAllele2) {
                $("#donorHlaType2").html(allele.alleleName);
                putAllele(allele).done(function() { $(".multiId-working").fadeOut(); });
            }
            $("#donorHlaTypePage div.options div.ui-block-a input[data-type=search]").blur();
            $("#donorHlaTypePage div.options div.ui-block-b input[data-type=search]").blur();
        });

        $(".multiId-working").fadeOut();
        
    });
    
});

$("#donorHlaTypePage").bind("pageshow", function () {
    
    if(!pageInitedMap["#donorHlaTypePage"]) {
        $("#donorHlaTypePage").trigger("pageinit");
    }
    
});
    
$("#compatibilityReportPage").bind("pageshow", function () {

    // Putting an allele here (alleles[0]) to make sure the enumerated allele
    // logic evaluates. This could help prevent confusion if someone is using
    // a non-enumerated and enumerated view with the same session (not sure
    // why this would ever happen, but it is worth defending against).
    initData(true).then(function() { return putAllele(alleles[0]); }).done(function() {

        var recipientAllele1 = alleles.find(function(allele) { return allele.recipientAllele1; });
        if(recipientAllele1) {
            $("#repRecipientHlaType1").html(recipientAllele1.alleleName);
            //$("#repRecipientHlaType1Epitopes").html(Object.values(recipientAllele1.hvrVariantMap).map(hvrv => hvrv.hypervariableRegionName + hvrv.variantId).join(", "));
        }
        else {
            $("#repRecipientHlaType1").html("not selected");
            //$("#repRecipientHlaType1Epitopes").html("");
        }

        var recipientAllele2 = alleles.find(function(allele) { return allele.recipientAllele2; });
        if(recipientAllele2) {
            $("#repRecipientHlaType2").html(recipientAllele2.alleleName);
            //$("#repRecipientHlaType2Epitopes").html(Object.values(recipientAllele2.hvrVariantMap).map(hvrv => hvrv.hypervariableRegionName + hvrv.variantId).join(", "));
        }
        else {
            $("#repRecipientHlaType2").html("not selected");
            //$("#repRecipientHlaType2Epitopes").html("");
        }

        var recipientAntibodies = alleles.filter(function(allele) { return allele.recipientAntibodyForCompat; }).map(allele => allele.alleleName);
        $("#repRecipientAntibodies").html(recipientAntibodies.length > 0 ? recipientAntibodies.join(", ") : "not selected");

        var knownReactiveEpitopes = [];
        $.each(hypervariableRegions, function(index, hypervariableRegion) {
            var hvrKnownReactiveEpitopes = Object.values(hypervariableRegion.variantMap).filter(function(hvrv) { return hvrv.knownReactiveEpitopeForCompat; })
            if(hvrKnownReactiveEpitopes.length > 0) { knownReactiveEpitopes.push(hvrKnownReactiveEpitopes.map(hvrv => hypervariableRegion.hypervariableRegionName + hvrv.variantId).join(", ")); }
        });
        $("#repRecipientEpitopesUser").html(knownReactiveEpitopes.length > 0 ? knownReactiveEpitopes.join(", ") : "none");

        var predictedReactiveEpitopes = [];
        $.each(hypervariableRegions, function(index, hypervariableRegion) {
            var hvrAntibodiesPresent = Object.values(hypervariableRegion.variantMap).filter(function(hvrv) { return hvrv.compatAntibodyConsideredPresent; })
            if(hvrAntibodiesPresent.length > 0) { predictedReactiveEpitopes.push(hvrAntibodiesPresent.map(hvrv => hypervariableRegion.hypervariableRegionName + hvrv.variantId).join(", ")); }
        });
        $("#repRecipientEpitopesPrediction").html(predictedReactiveEpitopes.length > 0 ? predictedReactiveEpitopes.join(", ") : "none");

        var donorAllele1 = alleles.find(function(allele) { return allele.donorAllele1; });
        if(donorAllele1) {
            $("#repDonorHlaType1").html(donorAllele1.alleleName);
            $("#repDonorHlaType1").css("color", compatibilityMap[donorAllele1.compatInterpretation].color);
            $("#repDonorHlaType1CompatibilityPrediction").html(compatibilityMap[donorAllele1.compatInterpretation].text);
            $("#repDonorHlaType1CompatibilityPrediction").css("color", compatibilityMap[donorAllele1.compatInterpretation].color);
        }
        else {
            $("#repDonorHlaType1").html("not selected");
            $("#repDonorHlaType1CompatibilityPrediction").html("");
        }

        var donorAllele2 = alleles.find(function(allele) { return allele.donorAllele2; });
        if(donorAllele2) {
            $("#repDonorHlaType2").html(donorAllele2.alleleName);
            $("#repDonorHlaType2").css("color", compatibilityMap[donorAllele2.compatInterpretation].color);
            $("#repDonorHlaType2CompatibilityPrediction").html(compatibilityMap[donorAllele2.compatInterpretation].text);
            $("#repDonorHlaType2CompatibilityPrediction").css("color", compatibilityMap[donorAllele2.compatInterpretation].color);
        }
        else {
            $("#repDonorHlaType2").html("not selected");
            $("#repDonorHlaType2CompatibilityPrediction").html("");
        }

        var lcs = alleles.filter(function(allele) { return allele.compatInterpretation == "LC"; }).map(allele => allele.alleleName.substring(allele.alleleName.indexOf("*") + 1));
        $("#likelyCompatible").html(lcs.length > 0 ? lcs.join("<br/>") : "none");

        var is = alleles.filter(function(allele) { return allele.compatInterpretation == "I"; }).map(allele => allele.alleleName.substring(allele.alleleName.indexOf("*") + 1));
        $("#incompatible").html(is.length > 0 ? is.join("<br/>") : "none");

        var lis = alleles.filter(function(allele) { return allele.compatInterpretation == "LI"; }).map(allele => allele.alleleName.substring(allele.alleleName.indexOf("*") + 1));
        $("#likelyIncompatible").html(lis.length > 0 ? lis.join("<br/>") : "none");

        var aas = alleles.filter(function(allele) { return allele.compatInterpretation == "AA"; }).map(allele => allele.alleleName.substring(allele.alleleName.indexOf("*") + 1));
        $("#possibleAutoantibody").html(aas.length > 0 ? aas.join("<br/>") : "none");
    
        $(".multiId-working").fadeOut();
        
    });
    
});

$(".multiId-resetButton").click(function() {
    pageInitedMap = new Object();
    alleles = []; // the array of alleles
    alleleMap = new Object(); // a map of alleles, indexed by allele name
    hypervariableRegions = []; // the array of hypervariableRegions
    hvrMap = new Object(); // a map of hypervariable regions, indexed by hypervariable region name + variant ID
    hvrvMap = new Object(); // a map of hypervariable region variants, indexd by hypervariable region anme + variant ID
    resetSession().done(function() { $(":mobile-pagecontainer").pagecontainer("change", "#recipientHlaTypePage"); $("#recipientHlaTypePage").trigger("pageshow"); });
});

</script>
